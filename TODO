Rewrite and clean up. This is a mess (but it works).
